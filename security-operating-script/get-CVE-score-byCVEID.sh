#!/bin/bash 

# 
#redhat/centos usage: bash ./get-CVE-score-byCVEID.sh ./downloaded-CVE-htmlpage-dir-from-NVD ./debsecan_report  ../rhsecapi/rhsecapi.py
#debian usage: bash ./get-CVE-score-byCVEID.sh ./downloaded-CVE-htmlpage-dir-from-NVD ./debsecan_report 
CVELISTDIR=$1
CVESCANPKGALL=$2
RHSECAPI=$3
#Example:
#CVELISTDIR=./CVE2
#CVESCANPKGALL=../zy-desktop-2-scan-all.csv
#RHSECAPI=./rhsecapi.py  https://github.com/RedHatOfficial/rhsecapi  

echo > "${CVELISTDIR}-score.csv"

for CVENAME in $(ls ${CVELISTDIR}); do
	LINENUM=$(sed -n "/vuln-cvss3-panel-score-na/=" "${CVELISTDIR}/${CVENAME}")
	LINENUM2=$(sed -n "/CVE ID Not Found/=" "${CVELISTDIR}/${CVENAME}")
	LINENUM3=$(sed -n "/vuln-cvss3-cna-panel-score/=" "${CVELISTDIR}/${CVENAME}")
	if [ "noscore" != "noscore${LINENUM}" ]; then
		echo "no score "
		SCORE="NOSCORE"
	elif [ "noscore" != "noscore${LINENUM2}" ]; then
		echo "not found "
		SCORE="NOTFOUND"
	elif [ "noscore" != "noscore${LINENUM3}" ]; then
		LINENUM=$(sed -n "/vuln-cvss3-cna-panel-score/=" "${CVELISTDIR}/${CVENAME}")
		((LINENUM=LINENUM+1))

		SCORE=$(sed -n "${LINENUM}"p "${CVELISTDIR}/${CVENAME}" | awk -F'>' '{print $2}' | awk -F'<' '{print $1}') 
	else
		LINENUM=$(sed -n "/vuln-cvss3-panel-score/=" "${CVELISTDIR}/${CVENAME}")
		((LINENUM=LINENUM+1))

		SCORE=$(sed -n "${LINENUM}"p "${CVELISTDIR}/${CVENAME}" | awk -F'>' '{print $2}' | awk -F'<' '{print $1}') 
	fi
	PKGLIST=$(grep ${CVENAME} ${CVESCANPKGALL}  | awk '{print $2}' | tr '\n' ' ' | sed 's/ $//')
	
	if [ "${SCORE}" = "NOSCORE" -o "${SCORE}" = "NOTFOUND" ]; then
		if [ -z "${RHSECAPI}" ]; then
			:
		else
			${RHSECAPI} ${CVENAME} --fields +cvss3 > /tmp/yygy;
			SCORE=$( grep CVSS3 /tmp/yygy | awk '{print $3}')	
		fi
	fi
	echo "${CVENAME}, ${SCORE}, ${PKGLIST}"
	echo "${CVENAME}, ${SCORE}, ${PKGLIST}" >> "${CVELISTDIR}-score.csv"
done

